<!DOCTYPE HTML>
<html>
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE"/>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <title>(Next) Tuesday</title>

<!-- Add in Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Saira" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Lexend" rel="stylesheet">
    <link href='https://fonts.googleapis.com/css?family=League Spartan' rel='stylesheet'>

  <link rel=stylesheet href="platform.css" type="text/css">
  <link rel=stylesheet href="libs/jquery/dateField/jquery.dateField.css" type="text/css">

  <link rel=stylesheet href="gantt.css" type="text/css">
  <link rel=stylesheet href="ganttPrint.css" type="text/css" media="print">
  <link rel=stylesheet href="libs/jquery/valueSlider/mb.slider.css" type="text/css" media="print">

<script>
  var contextPath = window.location.origin; // Sets contextPath to the current domain
</script>


  <script src="http://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

  <script src="libs/jquery/jquery.livequery.1.1.1.min.js"></script>
  <script src="libs/jquery/jquery.timers.js"></script>

  <script src="libs/utilities.js"></script>
  <script src="libs/forms.js"></script>
  <script src="libs/date.js"></script>
  <script src="libs/dialogs.js"></script>
  <script src="libs/layout.js"></script>
  <script src="libs/i18nJs.js"></script>
  <script src="libs/jquery/dateField/jquery.dateField.js"></script>
  <script src="libs/jquery/JST/jquery.JST.js"></script>
  <script src="libs/jquery/valueSlider/jquery.mb.slider.js"></script>

  <script type="text/javascript" src="libs/jquery/svg/jquery.svg.min.js"></script>
  <script type="text/javascript" src="libs/jquery/svg/jquery.svgdom.1.8.js"></script>

<!--    /* Comment this out as likely should be in the backend-->
<!--        <script src="seaviewConnection.js"></script>-->
<!--    */-->
  <script src="seaviewClient.js"></script>
  <script src="ganttUtilities.js"></script>
  <script src="ganttTask.js"></script>
  <script src="ganttDrawerSVG.js"></script>
  <script src="ganttZoom.js"></script>
  <script src="ganttGridEditor.js"></script>
  <script src="ganttMaster.js"></script>


  <!--<script src="libs/profiling.js"></script>-->
  <!--<script type="text/javascript" src="ganttTestSuite.js"></script>-->
</head>
<body style="background-color: #fff;">

<!-- Ribbon bar -->
<div id="ribbonBar">
    <h1>Tuesday</h1>
    <div>
        <button>Option 1</button>
        <button>Option 2</button>
        <button>Option 3</button>
    </div>
</div>


<!-- Main layout -->
<div class="layout-container">
    <!-- Collapsible side menu -->
    <div id="sideMenu">
        <button id="toggleSidebar">Toggle</button>
        <div id="menuContainer"></div>
    </div>

    <!-- Central workspace -->
    <div id="workSpaceContainer">
        <div id="workSpace"
             style="padding:0px; overflow-y:auto; overflow-x:hidden;border:1px solid #e5e5e5;position:relative;margin:0 5px"></div>
    </div>
</div>
<script>



//    // Get active portfolio list and update sidebar contents
//    $(document).ready(function () {
//
//        let userID = -1;
//        getMyUserID().then(result => {
//            userID = result;
//            console.log("End User ID: ", userID);
//        }).catch(error => {
//            console.error("Error initializing userID:", error);
//            userID = -1;
//        })
//        console.log("User ID: ", userID);
//
//        let maxTaskChangeCount = 0;
//        getMaxTaskChangeId().then(result => {
//            maxTaskChangeCount = result;
//        }).catch(error => {
//            console.error("Error initializing maxTaskChangeCount:", error);
//            maxTaskChangeCount = -1; // Fallback value in case of error
//        });
//        console.log("Max Task Change Count: ", maxTaskChangeCount);
//        // Prepped for later
//        // // Heartbeat mechanism that triggers periodic checks with the server
//        // const heartbeatInterval = 30000; // Interval in milliseconds (e.g., 30 seconds)
//        //
//        // const heartbeat = async () => {
//        //     try {
//        //         console.log("Heartbeat: Checking server status...");
//        //         const response = await fetch(`http://localhost:3000/heartbeat`);
//        //         if (!response.ok) {
//        //             throw new Error(`Heartbeat failed! HTTP error: ${response.status}`);
//        //         }
//        //         const serverData = await response.json();
//        //         console.log("Heartbeat response:", serverData);
//        //         // Use serverData to trigger specific actions if any updates or changes are detected
//        //     } catch (error) {
//        //         console.error("Heartbeat error:", error);
//        //     }
//        // };
//        //
//        // // Start the heartbeat
//        // setInterval(heartbeat, heartbeatInterval);
//
//        // projectTasks();
//
//        /* Test Section -----------------------------------------------------------------------*/
//        // console.log('Test Section')
//        // getUsername();
//        // // updateSidebarWithPortfolios();
//        // addBlankTaskToProject(1);
//        // console.log("Start task update");
//        // updateTask(1,{"id": 1,"title": "New Task","progress": 0.5});
//        // addTaskChange(1,{"id": 1,"title": "New Task","progress": 0.5});
//        // console.log("Task Updated");
//
//        // async function portfolioSelected(portfolioId) {
//        //     console.log("Portfolio Selected: ", portfolioId);
//        //     const portfolioContents = await getPortfolioContentsFromServer(portfolioId);
//        //     console.log("Portfolio Contents: ", portfolioContents);
//        //     return portfolioContents;
//        // }
//    });


</script>
<script>
    $(document).ready(() => {
        let userID = -1;
        getMyUserID().then(result => {
            userID = result;
            // console.log("End User ID: ", userID);
        }).catch(error => {
            console.error("Error initializing userID:", error);
            userID = -1;
        })
        console.log("User ID: ", userID);

        let maxTaskChangeCount = 0;
        getMaxTaskChangeId().then(result => {
            maxTaskChangeCount = result;
        }).catch(error => {
            console.error("Error initializing maxTaskChangeCount:", error);
            maxTaskChangeCount = -1; // Fallback value in case of error
        });
        console.log("Max Task Change Count: ", maxTaskChangeCount);



        const sideMenu = $("#menuContainer");

        // // Function to update Gantt view for a project
        // const updateGanttForProject = (projectId, userId) => {
        //     console.log(`Loading project ${projectId} into Gantt`);
        //     ganttMaster.loadProjectFromDatabase(projectId,userId);
        //     ganttMaster.loadTasksFromPostgreSQL(projectId);// Example function from ganttMaster
        // };

        // Function to create hierarchical menu
        const createHierarchicalMenu = async () => {
            try
            {
                const portfolios = await getPortfolioListFromServer(); // Fetch portfolios
                const portfoliosContents = [];
                for(let i = 0; i < portfolios.length; i++)
                {
                    const portfolioContents = {'programmes':[],'projects':[],'id':portfolios[i].id, "title": portfolios[i].title};
                    const pContents = await getPortfolioContentsFromServer(portfolios[i].id);
                    for(let j = 0; j < pContents.length; j++)
                    {
                        let progCt = 0;
                        if(pContents[j].programme_id != null)
                        {
                            portfolioContents.programmes.push({"id": pContents[j].programme_id, "title":pContents[j].title,"projects": []});
                            progCt = portfolioContents.programmes.length - 1;
                            const progProjs =  await getProgrammeContentsFromServer(pContents[j].programme_id);
                            for(let k = 0; k < progProjs.length; k++)
                            {
                                portfolioContents.programmes[progCt].projects.push({"id":progProjs[k].id,"title":progProjs[k].title});
                            }
                            // progCt++;

                        }
                        if(pContents[j].project_id != null)
                        {
                            portfolioContents.projects.push({"id":pContents[j].project_id,"title":pContents[j].title});
                        }
                    }
                    portfoliosContents.push(portfolioContents);
                    portfoliosContents[i].id = portfolios[i].id;
                }
                sideMenu.empty(); // Clear existing menu
                let portfolioCt = 0;
                portfoliosContents.forEach((portfolio) => {
                    const portfolioDiv = $("<div>")
                        .addClass("menuItem portfolio")
                        .text(portfolio.title)
                        .data('id', portfolio.id)
                        .data('type', 'portfolio');

                    portfolioDiv.on("click", function () {
                        // Show portfolio details
                        showSummaryWindow("Portfolio", portfolio.id);
                    });

                    portfolioDiv.on("dblclick", function ()
                    {
                        // Expand/collapse programmes under this portfolio
                        const childProgrammes = $(this).nextUntil(".portfolio", ".programme");
                        const childProjects = $(this).nextUntil(".portfolio", ".programme").addBack().nextUntil(".portfolio", ".portfolioProject");
                        const visibleChildren = childProgrammes.filter(":visible");
                        if (visibleChildren.length > 0)
                        {
                            // childProgrammes.slideUp();
                            // childProjects.slideUp();
                            $(this).nextUntil(".portfolio").slideUp();
                        }
                        else
                        {
                            childProgrammes.slideDown();
                            childProjects.slideDown();
                        }

                        window.getSelection()?.removeAllRanges();
                    });

                    sideMenu.append(portfolioDiv);

                    // Generate programmes for this portfolio
                    if (portfolio.programmes) {
                        const projProgs = async () => {
                            for(let i = 0; i < portfolio.programmes.length; i++)
                            {
                                const progProjs =  await getProgrammeContentsFromServer(portfolio.programmes[i].id);
                                for(let j = 0; j < progProjs.length; j++)
                                {
                                    portfoliosContents[portfolioCt].programmes[i].projects.push({"id":progProjs[j].id,"title":progProjs[j].title});
                                }
                            }
                            return true;
                        };
                        portfoliosContents[portfolioCt].programmes.forEach(async (programme) => {
                            const programmeDiv = $("<div>")
                                .addClass("menuItem programme")
                                .text(programme.title)
                                .data('id', programme.id)
                                .data('type', 'programme')
                                .css("display", "none"); // Initially hidden

                            programmeDiv.on("click", function () {
                                // Show programme details
                                showSummaryWindow("Programme", programme.id);
                            });

                            programmeDiv.on("dblclick", function () {
                                // Expand/collapse projects under this programme
                                const childProjects = $(this).nextUntil(".programme, .portfolio", ".programmeProject");
                                const visibleChildren = childProjects.filter(":visible");
                                if (visibleChildren.length > 0) {
                                    childProjects.slideUp();
                                } else {
                                    console.log("Child Projects: ", childProjects);
                                    childProjects.slideDown();
                                }
                                window.getSelection()?.removeAllRanges();
                            });

                            sideMenu.append(programmeDiv);

                            // Generate projects for this programme
                            if (programme.projects) {
                                programme.projects.forEach((project) => {
                                    const projectDiv = $("<div>")
                                        .addClass("menuItem programmeProject")
                                        .text(project.title)
                                        .data('id', project.id)
                                        .data('type', 'programmeProject')
                                        .css("display", "none"); // Initially hidden

                                    projectDiv.on("click", function () {
                                        // Show project details
                                        showSummaryWindow("Project", project.id);
                                    });

                                    projectDiv.on("dblclick", function () {
                                        // Load project into Gantt
                                        console.log("Load project into Gantt");
                                        console.log("GE:",ge);
                                        const projectId = project.id;
                                        ge.loadProjectFromDatabase(projectId, userID).then(() => {
                                            console.log(`Project ${projectId} loaded from database successfully.`);

                                            ge.loadTasksFromPostgreSQL(userID, projectId).then(() => {
                                                console.log(`Tasks for project ${projectId} loaded successfully.`);
                                            }).catch(error => {
                                                console.error(`Error loading tasks for project ${projectId}:`, error);
                                            });
                                            // Reset the background color of all other programmeProjects and portfolioProjects to default
                                            $(".menuItem.programmeProject, .menuItem.portfolioProject").css({"background-color": "", "box-shadow": "none"});


                                            // Add shadow effect to improved selection visibility
                                            $(this).css({
                                                "background-color": "#ffffff", // Change background to white
                                                "box-shadow": "0px 4px 8px rgba(0, 0, 0, 0.2)" // Add subtle shadow
                                            });
                                        }).catch(error => {
                                            console.error(`Error loading project ${projectId} from database:`, error);
                                        });
                                    });
                                    sideMenu.append(projectDiv);
                                });
                            }
                        });
                    }

                    // Generate projects directly under this portfolio
                    if (portfolio.projects) {
                        portfolio.projects.forEach((project) => {
                            const projectDiv = $("<div>")
                                .addClass("menuItem portfolioProject")
                                .text(project.title)
                                .data('id', project.id)
                                .data('type', 'portfolioProject')
                                .css("display", "none"); // Initially hidden

                            projectDiv.on("click", function () {
                                // Show project details
                                showSummaryWindow("Project", project.id);
                            });

                            projectDiv.on("dblclick", function () {
                                // Load project into Gantt
                                // TODO: Fix this connection to the gannt window
                                // updateGanttForProject(project.id);
                                console.log("Load project into Gantt");
                                console.log("GE:",ge);
                                const projectId = project.id;
                                ge.loadProjectFromDatabase(projectId, userID).then(() => {
                                    console.log(`Project ${projectId} loaded from database successfully.`);

                                    ge.loadTasksFromPostgreSQL(userID, projectId).then(() => {
                                        console.log(`Tasks for project ${projectId} loaded successfully.`);
                                    }).catch(error => {
                                        console.error(`Error loading tasks for project ${projectId}:`, error);
                                    });
                                    

                                    // Reset the background color of all other programmeProjects and portfolioProjects to default
                                    $(".menuItem.programmeProject, .menuItem.portfolioProject").css({"background-color": "", "box-shadow": "none"});


                                    // Add shadow effect to improved selection visibility
                                    $(this).css({
                                        "background-color": "#ffffff", // Change background to white
                                        "box-shadow": "0px 4px 8px rgba(0, 0, 0, 0.2)" // Add subtle shadow
                                    });
                                    
                                }).catch(error => {
                                    console.error(`Error loading project ${projectId} from database:`, error);
                                });
                            });

                            sideMenu.append(projectDiv);
                        });
                    }
                    portfolioCt++;
                });
            } catch (error) {
                console.error("Error creating hierarchical menu:", error);
            }
            // console.log(sideMenu);
        };

        // Summary window function
        const showSummaryWindow = (type, id) => {
            console.log(`Showing summary for ${type} with ID: ${id}`);
            // TODO: Add logic to open and populate the summary window based on the type and ID
        };

        // Initialize hierarchical menu
        createHierarchicalMenu();
    });
</script>

<style>
    #menuContainer {
/*        margin-top: 10px;
        padding-left: 10px;*/
        padding: 10px;
        box-sizing: border-box;
    }

    .menuItem {
        margin: 5px 0;
        padding: 5px;
        cursor: pointer;
        border: 1px solid #e5e5e5;
        border-radius: 5px;
    }

    .menuItem:hover {
        background-color: #f0f0f0;
    }

    .menuItem.portfolio {
        font-weight: bold;
    }

    .menuItem.programme {
        padding-left: 20px;
    }

    .menuItem.portfolioProject {
        padding-left: 30px;
    }


    .menuItem.programmeProject {
        padding-left: 40px;
    }
</style>

<!-- Main layout -->
<!--<div class="layout-container">-->
<!--    &lt;!&ndash; Collapsible side menu &ndash;&gt;-->
<!--    <div id="sideMenu">-->
<!--        <button id="toggleSidebar">Toggle</button>-->
<!--        <ul>-->
<!--            <li>Menu Item 1</li>-->
<!--            <li>Menu Item 2</li>-->
<!--            <li>Menu Item 3</li>-->
<!--        </ul>-->
<!--    </div>-->

<!--    &lt;!&ndash; Central workspace &ndash;&gt;-->
<!--    <div id="workSpaceContainer">-->
<!--        <div id="workSpace" style="padding:0px; overflow-y:auto; overflow-x:hidden;border:1px solid #e5e5e5;position:relative;margin:0 5px"></div>-->
<!--    </div>-->
<!--</div>-->




<!-- Footer -->
<div id="statusBar">
    <style>
        /* Ensure the footer is always visible */
        #statusBar {
            display: block !important;
        }
    </style>
    Status: All systems operational
</div>

<script>
    // Toggle side menu collapse
    $("#toggleSidebar").on("click", function () {
        $("#sideMenu").toggleClass("collapsed");
    });
</script>

<!--
<div id="workSpace" style="padding:0px; overflow-y:auto; overflow-x:hidden;border:1px solid #e5e5e5;position:relative;margin:0 5px"></div>
-->

<style>
  .resEdit {
    padding: 15px;
  }

  .resLine {
    width: 95%;
    padding: 3px;
    margin: 5px;
    border: 1px solid #d0d0d0;
  }

  body {
    overflow: hidden;
  }

  .ganttButtonBar h1{
    color: #000000;
    font-weight: bold;
    font-size: 28px;
    margin-left: 10px;
  }

  /* Ribbon bar styling */
  #ribbonBar {
      background-color: #007bff;
      color: #fff;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
  }

  #ribbonBar h1 {
      font-size: 20px;
      margin: 0;
  }



  /* Collapsible sidebar styling */
  #sideMenu {
      background-color: #f5f5f5;
      width: 200px;
      min-width: 200px;
      transition: all 0.3s ease;
      border-right: 1px solid #ddd;
  }

  #sideMenu.collapsed {
      width: 50px;
      min-width: 50px;
  }

  #sideMenu ul {
      list-style: none;
      padding: 10px;
  }

  #sideMenu ul li {
      padding: 10px 15px;
      cursor: pointer;
  }

  #sideMenu ul li:hover {
      background-color: #eee;
  }

  #toggleSidebar {
      background: none;
      border: none;
      color: inherit;
      font-size: 16px;
      cursor: pointer;
      margin-bottom: 10px;
  }

  /* Central workspace styling */
  #workSpaceContainer {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
  }

  #statusBar {
      position: fixed;
      bottom: 0;
      height: 30px;
      width: 100%;
      background-color: #f1f1f1; /* Example background color */
      text-align: center;
      padding: 10px 0;
  }

  /* Layout container */
  .layout-container {
      display: flex;
      flex: 1;
      height: calc(100vh - 60px - 30px); /* 60px is the ribbon bar height, 30px is the status bar height */
      overflow: hidden;
  }
</style>

<form id="gimmeBack" style="display:none;" action="../gimmeBack.jsp" method="post" target="_blank"><input type="hidden" name="prj" id="gimBaPrj"></form>

<script type="text/javascript">

var ge;
$(/**
 * Initializes the Gantt chart and loads the project data.
 * Configures the GanttMaster instance and prepares the workspace for display.
 * Ensures that localization is applied, project data is loaded,
 * write access is managed, and the history management is initialized.
 */
function() {
        // console.log("jQuery ready function fired");

        var canWrite = true; //this is the default for test purposes

        // here starts gantt initialization
        ge = new GanttMaster();

        // Find the workspace element
        const workSpaceElement = $("#workSpace");
        if (workSpaceElement.length === 0) {
            console.error("Workspace element (#workSpace) not found in DOM.");
            return;
        }
        // console.log("Workspace element found:", workSpaceElement);

        // Initialize the Gantt editor with workspace
        ge.init(workSpaceElement);


        getMyUserID().then(async uID => {
            const project = await ge.loadProjectFromDatabase(1, uID);
            if (!project) {
                console.error("Project not found or invalid.");
                throw new Error("Invalid project");
            }
            return project;
        }).then(async project => {
            console.log(">>>>>>>>>>>>>>>>>>>>>> G Debug: 1");
            // const tasks = await ge.loadTasksFromPostgreSQL(1);
            console.log("tasks: ", ge.tasks);
            console.log(">>>>>>>>>>>>>>>>>>>>>> G Debug: 1.1");
            return {project, tasks};
        }).then(({project, tasks}) => {
            console.log(">>>>>>>>>>>>>>>>>>>>>> G Debug: 2");

            ge.set100OnClose = true;
            ge.shrinkParent = true;

            loadI18n(); // Overwrite with localized resources
            console.log(">>>>>>>>>>>>>>>>>>>>>> G Debug: 3");
            // Force compute the best-fitting zoom level
            delete ge.gantt.zoom;

            if (!project.canWrite) {
                $(".ganttButtonBar button.requireWrite").attr("disabled", "true");
            }

            console.log(">>>>>>>>>>>>>>>>>>>>>> G Debug: 4");
            ge.checkpoint(); // Empty the undo stack (checkpoint)

            if (ge.tasks && ge.tasks.length > 0) {
                initializeHistoryManagement(ge.tasks[0].id); // Initialize history management with the first task's ID
            } else {
                console.error("No tasks available to initialize history management.");
            }
            console.log(">>>>>>>>>>>>>>>>>>>>>> G Debug: 5");
        }).catch(error => {
            console.error("Error loading tasks:", error);
        });
    }
);






/**
 * Retrieves a demonstration project containing tasks, resources, and roles.
 * The project data includes tasks with attributes such as start and end times,
 * progress, dependencies, and hierarchical relationships. Each task's start time
 * is updated relative to the current time during runtime.
 *
 * @return {Object} An object representing the demo project. It includes a list of tasks, resources, roles,
 * and permissions related to the project, structured to simulate a project management scenario.
 */
function getDemoProject(){
  //console.debug("getDemoProject")
ret= {"tasks":    [
      {"id": -1, "name": "Gantt editor", "progress": 0, "progressByWorklog": false, "relevance": 0, "type": "", "typeId": "", "description": "", "code": "", "level": 0, "status": "STATUS_ACTIVE", "depends": "", "canWrite": true, "start": 1396994400000, "duration": 20, "end": 1399586399999, "startIsMilestone": false, "endIsMilestone": false, "collapsed": false, "assigs": [], "hasChild": true},
      {"id": -2, "name": "coding", "progress": 0, "progressByWorklog": false, "relevance": 0, "type": "", "typeId": "", "description": "", "code": "", "level": 1, "status": "STATUS_ACTIVE", "depends": "", "canWrite": true, "start": 1396994400000, "duration": 10, "end": 1398203999999, "startIsMilestone": false, "endIsMilestone": false, "collapsed": false, "assigs": [], "hasChild": true},
      {"id": -3, "name": "gantt part", "progress": 0, "progressByWorklog": false, "relevance": 0, "type": "", "typeId": "", "description": "", "code": "", "level": 2, "status": "STATUS_ACTIVE", "depends": "", "canWrite": true, "start": 1396994400000, "duration": 2, "end": 1397167199999, "startIsMilestone": false, "endIsMilestone": false, "collapsed": false, "assigs": [], "hasChild": false},
      {"id": -4, "name": "editor part", "progress": 0, "progressByWorklog": false, "relevance": 0, "type": "", "typeId": "", "description": "", "code": "", "level": 2, "status": "STATUS_SUSPENDED", "depends": "3", "canWrite": true, "start": 1397167200000, "duration": 4, "end": 1397685599999, "startIsMilestone": false, "endIsMilestone": false, "collapsed": false, "assigs": [], "hasChild": false},
      {"id": -5, "name": "testing", "progress": 0, "progressByWorklog": false, "relevance": 0, "type": "", "typeId": "", "description": "", "code": "", "level": 1, "status": "STATUS_SUSPENDED", "depends": "2:5", "canWrite": true, "start": 1398981600000, "duration": 5, "end": 1399586399999, "startIsMilestone": false, "endIsMilestone": false, "collapsed": false, "assigs": [], "hasChild": true},
      {"id": -6, "name": "test on safari", "progress": 0, "progressByWorklog": false, "relevance": 0, "type": "", "typeId": "", "description": "", "code": "", "level": 2, "status": "STATUS_SUSPENDED", "depends": "", "canWrite": true, "start": 1398981600000, "duration": 2, "end": 1399327199999, "startIsMilestone": false, "endIsMilestone": false, "collapsed": false, "assigs": [], "hasChild": false},
      {"id": -7, "name": "test on ie", "progress": 0, "progressByWorklog": false, "relevance": 0, "type": "", "typeId": "", "description": "", "code": "", "level": 2, "status": "STATUS_SUSPENDED", "depends": "6", "canWrite": true, "start": 1399327200000, "duration": 3, "end": 1399586399999, "startIsMilestone": false, "endIsMilestone": false, "collapsed": false, "assigs": [], "hasChild": false},
      {"id": -8, "name": "test on chrome", "progress": 0, "progressByWorklog": false, "relevance": 0, "type": "", "typeId": "", "description": "", "code": "", "level": 2, "status": "STATUS_SUSPENDED", "depends": "6", "canWrite": true, "start": 1399327200000, "duration": 2, "end": 1399499999999, "startIsMilestone": false, "endIsMilestone": false, "collapsed": false, "assigs": [], "hasChild": false}
    ], "selectedRow": 2, "deletedTaskIds": [],
      "resources": [
      {"id": "tmp_1", "name": "Resource 1"},
      {"id": "tmp_2", "name": "Resource 2"},
      {"id": "tmp_3", "name": "Resource 3"},
      {"id": "tmp_4", "name": "Resource 4"}
    ],
      "roles":       [
      {"id": "tmp_1", "name": "Project Manager"},
      {"id": "tmp_2", "name": "Worker"},
      {"id": "tmp_3", "name": "Stakeholder"},
      {"id": "tmp_4", "name": "Customer"}
    ], "canWrite":    true, "canDelete":true, "canWriteOnParent": true, canAdd:true}


    //actualize data
    var offset=new Date().getTime()-ret.tasks[0].start;
    for (var i=0;i<ret.tasks.length;i++) {
      ret.tasks[i].start = ret.tasks[i].start + offset;
    }
  return ret;
}



/**
 * Loads Gantt data from the server or local storage.
 *
 * @param {string} taskId - The ID of the task to load data for.
 * @param {function} callback - A callback function to execute after loading is complete.
 * @return {Object} Returns the data loaded from local storage or the server.
 */
function loadGanttFromServer(taskId, callback) {

  //this is a simulation: load data from the local storage if you have already played with the demo or a textarea with starting demo data
  var ret=loadFromLocalStorage();

  //this is the real implementation
  /*
  //var taskId = $("#taskSelector").val();
  var prof = new Profiler("loadServerSide");
  prof.reset();

  $.getJSON("ganttAjaxController.jsp", {CM:"LOADPROJECT",taskId:taskId}, function(response) {
    //console.debug(response);
    if (response.ok) {
      prof.stop();

      ge.loadProject(response.project);
      ge.checkpoint(); //empty the undo stack

      if (typeof(callback)=="function") {
        callback(response);
      }
    } else {
      jsonErrorHandling(response);
    }
  });
  */

  return ret;
}

/**
 * Reads a file, parses its content as JSON, and loads a project with the parsed data.
 * Clears the undo stack after loading the project.
 *
 * @param {File} uploadedFile - The file to be uploaded and processed.
 * @return {void} This method does not return a value.
 */
function upload(uploadedFile) {
  var fileread = new FileReader();
  
  fileread.onload = function(e) {
    var content = e.target.result;
    var intern = JSON.parse(content); // Array of Objects.
    //console.log(intern); // You can index every object
    
    // ge.loadProject(intern);
    ge.checkpoint(); //empty the undo stack

  };

  fileread.readAsText(uploadedFile);
}

/**
 * Saves the current Gantt project data to the server or downloads it as a JSON file.
 *
 * The method extracts the current state of the project using the saveProject function,
 * and then provides a download prompt for the user to save the project data as a JSON file.
 * The commented-out portion includes simulation for server-side saving via AJAX and local storage.
 *
 * @return {void} This function does not return a value but operates as a side effect
 *                to save or download the Gantt project data.
 */
function saveGanttOnServer() {

  //this is a simulation: save data to the local storage or to the textarea
  //saveInLocalStorage();

  var prj = ge.saveProject();

  download(JSON.stringify(prj, null, '\t'), "MyProject.json", "application/json");

  /*

  delete prj.resources;
  delete prj.roles;

  var prof = new Profiler("saveServerSide");
  prof.reset();

  if (ge.deletedTaskIds.length>0) {
    if (!confirm("TASK_THAT_WILL_BE_REMOVED\n"+ge.deletedTaskIds.length)) {
      return;
    }
  }

  $.ajax("ganttAjaxController.jsp", {
    dataType:"json",
    data: {CM:"SVPROJECT",prj:JSON.stringify(prj)},
    type:"POST",

    success: function(response) {
      if (response.ok) {
        prof.stop();
        if (response.project) {
          ge.loadProject(response.project); //must reload as "tmp_" ids are now the good ones
        } else {
          ge.reset();
        }
      } else {
        var errMsg="Errors saving project\n";
        if (response.message) {
          errMsg=errMsg+response.message+"\n";
        }

        if (response.errorMessages.length) {
          errMsg += response.errorMessages.join("\n");
        }

        alert(errMsg);
      }
    }

  });
  */
}

// Function to download data to a file
/**
 * Facilitates downloading of a file by creating and triggering a download link dynamically.
 *
 * @param {string|Blob} data - The content of the file to be downloaded.
 * @param {string} filename - The name of the file to be downloaded, including extension.
 * @param {string} type - The MIME type of the file (e.g., "text/plain", "application/json").
 * @return {void} This function does not return any value.
 */
/*
function download(data, filename, type) {
  var file = new Blob([data], {type: type});
  if (window.navigator.msSaveOrOpenBlob) // IE10+
    window.navigator.msSaveOrOpenBlob(file, filename);
  else { // Others
    var a = document.createElement("a"),
      url = URL.createObjectURL(file);
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(function() {
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);  
    }, 0); 
  }
}*/

/**
 * Initializes a new project by clearing the Gantt chart.
 *
 * @return {void} This method does not return a value.
 */
/*
function newProject(){
  clearGantt();
}
*/

/**
 * Clears the Gantt chart by resetting its state and removing any stored data or configurations.
 *
 * @return {void} This method does not return any value.
 */
function clearGantt() {
  ge.reset();
}

//-------------------------------------------  Get project file as JSON (used for migrate project from gantt to Teamwork) ------------------------------------------------------
/**
 * Handles the process of saving and submitting project data using a form.
 * The method serializes the project data, assigns it to a hidden input element, submits the form,
 * and then clears the input value for future use.
 *
 * @return {void} Does not return a value.
 */
/*
// function getFile() {
//   $("#gimBaPrj").val(JSON.stringify(ge.saveProject()));
//   $("#gimmeBack").submit();
//   $("#gimBaPrj").val("");
//
//   /*  var uriContent = "data:text/html;charset=utf-8," + encodeURIComponent(JSON.stringify(prj));
//    neww=window.open(uriContent,"dl");*/
// }


// /**
//  * Loads project data from the local storage. If no data is found or the data
//  * is incomplete (e.g., no tasks are present), it generates a new example project.
//  *
//  * @return {Object} The project data retrieved from local storage, or a new
//  * example project object if no valid data is found.
//  */
// function loadFromLocalStorage() {
//   var ret;
//   if (localStorage) {
//     if (localStorage.getObject("teamworkGantDemo")) {
//       ret = localStorage.getObject("teamworkGantDemo");
//     }
//   }
//
//   //if not found create a new example task
//   if (!ret || !ret.tasks || ret.tasks.length == 0){
//     ret=getDemoProject();
//   }
//   return ret;
// }


// /**
//  * Saves the current project data into the local storage with a predefined key.
//  * The method retrieves the current project details, serializes it,
//  * and stores it into the browser's local storage if available.
//  *
//  * @return {void} This method does not return a value.
//  */
// function saveInLocalStorage() {
//   var prj = ge.saveProject();
//
//   if (localStorage) {
//     localStorage.setObject("teamworkGantDemo", prj);
//   }
// }


//-------------------------------------------  Open a black popup for managing resources. This is only an axample of implementation (usually resources come from server) ------------------------------------------------------
/**
 * Handles the editing of resources within the application by creating a resource editor interface.
 * The method allows users to add, modify, and remove resources, updating the resource list and associated tasks accordingly.
 *
 * @return {void} This function does not return any value. It updates the internal state of resources and tasks directly.
 */
function editResources(){

  //make resource editor
  var resourceEditor = $.JST.createFromTemplate({}, "RESOURCE_EDITOR");
  var resTbl=resourceEditor.find("#resourcesTable");

  for (var i=0;i<ge.resources.length;i++){
    var res=ge.resources[i];
    resTbl.append($.JST.createFromTemplate(res, "RESOURCE_ROW"))
  }


  //bind add resource
  resourceEditor.find("#addResource").click(function(){
    resTbl.append($.JST.createFromTemplate({id:"new",name:"resource"}, "RESOURCE_ROW"))
  });

  //bind save event
  resourceEditor.find("#resSaveButton").click(function(){
    var newRes=[];
    //find for deleted res
    for (var i=0;i<ge.resources.length;i++){
      var res=ge.resources[i];
      var row = resourceEditor.find("[resId="+res.id+"]");
      if (row.length>0){
        //if still there save it
        var name = row.find("input[name]").val();
        if (name && name!="")
          res.name=name;
        newRes.push(res);
      } else {
        //remove assignments
        for (var j=0;j<ge.tasks.length;j++){
          var task=ge.tasks[j];
          var newAss=[];
          for (var k=0;k<task.assigs.length;k++){
            var ass=task.assigs[k];
            if (ass.resourceId!=res.id)
              newAss.push(ass);
          }
          task.assigs=newAss;
        }
      }
    }

    //loop on new rows
    var cnt=0
    resourceEditor.find("[resId=new]").each(function(){
      cnt++;
      var row = $(this);
      var name = row.find("input[name]").val();
      if (name && name!="")
        newRes.push (new Resource("tmp_"+new Date().getTime()+"_"+cnt,name));
    });

    ge.resources=newRes;

    closeBlackPopup();
    ge.redraw();
  });


  var ndo = createModalPopup(400, 500).append(resourceEditor);
}

/**
 * Initializes history management for a specific task by retrieving recorded history points and enabling interactive history navigation on the UI.
 *
 * @param {number} taskId - The unique identifier of the task for which the history management will be initialized.
 * @return {void} - This function does not return a value.
 */
function initializeHistoryManagement(taskId){

  //retrieve from server the list of history points in millisecond that represent the instant when the data has been recorded
  //response: {ok:true, historyPoints: [1498168800000, 1498600800000, 1498687200000, 1501538400000, â€¦]}
  $.getJSON(contextPath+"/applications/teamwork/task/taskAjaxController.jsp", {CM: "GETGANTTHISTPOINTS", OBJID:taskId}, function (response) {

    //if there are history points
    if (response.ok == true && response.historyPoints && response.historyPoints.length>0) {

      //add show slider button on button bar
      var histBtn = $("<button>").addClass("button textual icon lreq30 lreqLabel").attr("title", "SHOW_HISTORY").append("<span class=\"teamworkIcon\">&#x60;</span>");

      //clicking it
      histBtn .click(function () {
        var el = $(this);
        var ganttButtons = $(".ganttButtonBar .buttons");

        //is it already on?
        if (!ge.element.is(".historyOn")) {
          ge.element.addClass("historyOn");
          ganttButtons.find(".requireCanWrite").hide();

          //load the history points from server again
          showSavingMessage();
          $.getJSON(contextPath + "/applications/teamwork/task/taskAjaxController.jsp", {CM: "GETGANTTHISTPOINTS", OBJID: ge.tasks[0].id}, function (response) {
            jsonResponseHandling(response);
            hideSavingMessage();
            if (response.ok == true) {
              var dh = response.historyPoints;
              if (dh && dh.length > 0) {
                //si crea il div per lo slider
                var sliderDiv = $("<div>").prop("id", "slider").addClass("lreq30 lreqHide").css({"display":"inline-block","width":"500px"});
                ganttButtons.append(sliderDiv);

                var minVal = 0;
                var maxVal = dh.length-1 ;

                $("#slider").show().mbSlider({
                  rangeColor : '#2f97c6',
                  minVal     : minVal,
                  maxVal     : maxVal,
                  startAt    : maxVal,
                  showVal    : false,
                  grid       :1,
                  formatValue: function (val) {
                    return new Date(dh[val]).format();
                  },
                  onSlideLoad: function (obj) {
                    this.onStop(obj);

                  },
                  onStart    : function (obj) {},
                  onStop     : function (obj) {
                    var val = $(obj).mbgetVal();
                    showSavingMessage();
                    /**
                     * load the data history for that milliseconf from server
                     * response in this format {ok: true, baselines: {...}}
                     *
                     * baselines: {61707: {duration:1,endDate:1550271599998,id:61707,progress:40,startDate:1550185200000,status:"STATUS_WAITING",taskId:"3055"},
                     *            {taskId:{duration:in days,endDate:in millis,id:history record id,progress:in percent,startDate:in millis,status:task status,taskId:"3055"}....}}                     */

                    $.getJSON(contextPath + "/applications/teamwork/task/taskAjaxController.jsp", {CM: "GETGANTTHISTORYAT", OBJID: ge.tasks[0].id, millis:dh[val]}, function (response) {
                      jsonResponseHandling(response);
                      hideSavingMessage();
                      if (response.ok ) {
                        ge.baselines=response.baselines;
                        ge.showBaselines=true;
                        ge.baselineMillis=dh[val];
                        ge.redraw();
                      }
                    })

                  },
                  onSlide    : function (obj) {
                    clearTimeout(obj.renderHistory);
                    var self = this;
                    obj.renderHistory = setTimeout(function(){
                      self.onStop(obj);
                    }, 200)

                  }
                });
              }
            }
          });


          // closing the history
        } else {
          //remove the slider
          $("#slider").remove();
          ge.element.removeClass("historyOn");
          if (ge.permissions.canWrite)
            ganttButtons.find(".requireCanWrite").show();

          ge.showBaselines=false;
          ge.baselineMillis=undefined;
          ge.redraw();
        }

      });
      $("#saveGanttButton").before(histBtn);
    }
  })
}

/**
 * Displays a balloon with baseline information for an element when triggered by an event.
 *
 * @param {Object} event - The event that triggers the display of the balloon.
 * @param {Object} element - The DOM element associated with the baseline information.
 * @return {void}
 */
function showBaselineInfo (event,element){
  //alert(element.attr("data-label"));
  $(element).showBalloon(event, $(element).attr("data-label"));
  ge.splitter.secondBox.one("scroll",function(){
    $(element).hideBalloon();
  })
}

</script>





<div id="gantEditorTemplates" style="display:none;">
<div class="__template__" type="GANTBUTTONS">
  <!--
  <div class="ganttButtonBar noprint">
    <div class="buttons">
      

      <button onclick="$('#workSpace').trigger('undo.gantt');return false;" class="button textual icon requireCanWrite" title="undo"><span class="teamworkIcon">&#39;</span></button>
      <button onclick="$('#workSpace').trigger('redo.gantt');return false;" class="button textual icon requireCanWrite" title="redo"><span class="teamworkIcon">&middot;</span></button>
      <span class="ganttButtonSeparator requireCanWrite requireCanAdd"></span>
      <button onclick="$('#workSpace').trigger('addAboveCurrentTask.gantt');return false;" class="button textual icon requireCanWrite requireCanAdd" title="insert above"><span class="teamworkIcon">l</span></button>
      <button onclick="$('#workSpace').trigger('addBelowCurrentTask.gantt');return false;" class="button textual icon requireCanWrite requireCanAdd" title="insert below"><span class="teamworkIcon">X</span></button>
      <span class="ganttButtonSeparator requireCanWrite requireCanInOutdent"></span>
      <button onclick="$('#workSpace').trigger('outdentCurrentTask.gantt');return false;" class="button textual icon requireCanWrite requireCanInOutdent" title="un-indent task"><span class="teamworkIcon">.</span></button>
      <button onclick="$('#workSpace').trigger('indentCurrentTask.gantt');return false;" class="button textual icon requireCanWrite requireCanInOutdent" title="indent task"><span class="teamworkIcon">:</span></button>
      <span class="ganttButtonSeparator requireCanWrite requireCanMoveUpDown"></span>
      <button onclick="$('#workSpace').trigger('moveUpCurrentTask.gantt');return false;" class="button textual icon requireCanWrite requireCanMoveUpDown" title="move up"><span class="teamworkIcon">k</span></button>
      <button onclick="$('#workSpace').trigger('moveDownCurrentTask.gantt');return false;" class="button textual icon requireCanWrite requireCanMoveUpDown" title="move down"><span class="teamworkIcon">j</span></button>
      <span class="ganttButtonSeparator requireCanWrite requireCanDelete"></span>
      <button onclick="$('#workSpace').trigger('deleteFocused.gantt');return false;" class="button textual icon delete requireCanWrite" title="Elimina"><span class="teamworkIcon">&cent;</span></button>
      <span class="ganttButtonSeparator"></span>
      <button onclick="$('#workSpace').trigger('expandAll.gantt');return false;" class="button textual icon " title="EXPAND_ALL"><span class="teamworkIcon">6</span></button>
      <button onclick="$('#workSpace').trigger('collapseAll.gantt'); return false;" class="button textual icon " title="COLLAPSE_ALL"><span class="teamworkIcon">5</span></button>

    <span class="ganttButtonSeparator"></span>
      <button onclick="$('#workSpace').trigger('zoomMinus.gantt'); return false;" class="button textual icon " title="zoom out"><span class="teamworkIcon">)</span></button>
      <button onclick="$('#workSpace').trigger('zoomPlus.gantt');return false;" class="button textual icon " title="zoom in"><span class="teamworkIcon">(</span></button>
    <span class="ganttButtonSeparator"></span>
      <button onclick="$('#workSpace').trigger('print.gantt');return false;" class="button textual icon " title="Print"><span class="teamworkIcon">p</span></button>
    <span class="ganttButtonSeparator"></span>
      <button onclick="ge.gantt.showCriticalPath=!ge.gantt.showCriticalPath; ge.redraw();return false;" class="button textual icon requireCanSeeCriticalPath" title="CRITICAL_PATH"><span class="teamworkIcon">&pound;</span></button>
    <span class="ganttButtonSeparator requireCanSeeCriticalPath"></span>
      <button onclick="ge.splitter.resize(.1);return false;" class="button textual icon" ><span class="teamworkIcon">F</span></button>
      <button onclick="ge.splitter.resize(50);return false;" class="button textual icon" ><span class="teamworkIcon">O</span></button>
      <button onclick="ge.splitter.resize(100);return false;" class="button textual icon"><span class="teamworkIcon">R</span></button>
      <span class="ganttButtonSeparator"></span>
      <button onclick="$('#workSpace').trigger('fullScreen.gantt');return false;" class="button textual icon" title="FULLSCREEN" id="fullscrbtn"><span class="teamworkIcon">@</span></button>
      <button onclick="ge.element.toggleClass('colorByStatus' );return false;" class="button textual icon"><span class="teamworkIcon">&sect;</span></button>

    <button onclick="editResources();" class="button textual requireWrite" title="edit resources"><span class="teamworkIcon">M</span></button>
      &nbsp; &nbsp; &nbsp; &nbsp;
    </div>

  </div>
  -->
</div>

<div class="__template__" type="TASKSEDITHEAD"><!--
  <table class="gdfTable" cellspacing="0" cellpadding="0">
    <thead>
    <tr style="height:40px">
      <th class="gdfColHeader" style="width:35px; border-right: none"></th>
      <th class="gdfColHeader" style="width:25px;"></th>
      <th class="gdfColHeader gdfResizable" style="width:100px;">code/short name</th>
      <th class="gdfColHeader gdfResizable" style="width:300px;">name</th>
      <th class="gdfColHeader"  align="center" style="width:17px;" title="Start date is a milestone."><span class="teamworkIcon" style="font-size: 8px;">^</span></th>
      <th class="gdfColHeader gdfResizable" style="width:80px;">start</th>
      <th class="gdfColHeader"  align="center" style="width:17px;" title="End date is a milestone."><span class="teamworkIcon" style="font-size: 8px;">^</span></th>
      <th class="gdfColHeader gdfResizable" style="width:80px;">End</th>
      <th class="gdfColHeader gdfResizable" style="width:50px;">dur.</th>
      <th class="gdfColHeader gdfResizable" style="width:20px;">%</th>
      <th class="gdfColHeader gdfResizable requireCanSeeDep" style="width:50px;">depe.</th>
      <th class="gdfColHeader gdfResizable" style="width:1000px; text-align: left; padding-left: 10px;">assignees</th>
    </tr>
    </thead>
  </table>
  --></div>

<div class="__template__" type="TASKROW"><!--
  <tr id="tid_(#=obj.id#)" taskId="(#=obj.id#)" class="taskEditRow (#=obj.isParent()?'isParent':''#) (#=obj.collapsed?'collapsed':''#)" level="(#=level#)">
    <th class="gdfCell edit" align="right" style="cursor:pointer;"><span class="taskRowIndex">(#=obj.getRow()+1#)</span> <span class="teamworkIcon" style="font-size:12px;" >e</span></th>
    <td class="gdfCell noClip" align="center"><div class="taskStatus cvcColorSquare" status="(#=obj.status#)"></div></td>
    <td class="gdfCell"><input type="text" name="code" value="(#=obj.code?obj.code:''#)" placeholder="code/short name"></td>
    <td class="gdfCell indentCell" style="padding-left:(#=obj.level*10+18#)px;">
      <div class="exp-controller" align="center"></div>
      <input type="text" name="name" value="(#=obj.name#)" placeholder="name">
    </td>
    <td class="gdfCell" align="center"><input type="checkbox" name="startIsMilestone"></td>
    <td class="gdfCell"><input type="text" name="start"  value="" class="date"></td>
    <td class="gdfCell" align="center"><input type="checkbox" name="endIsMilestone"></td>
    <td class="gdfCell"><input type="text" name="end" value="" class="date"></td>
    <td class="gdfCell"><input type="text" name="duration" autocomplete="off" value="(#=obj.duration#)"></td>
    <td class="gdfCell"><input type="text" name="progress" class="validated" entrytype="PERCENTILE" autocomplete="off" value="(#=obj.progress?obj.progress:''#)" (#=obj.progressByWorklog?"readOnly":""#)></td>
    <td class="gdfCell requireCanSeeDep"><input type="text" name="depends" autocomplete="off" value="(#=obj.depends#)" (#=obj.hasExternalDep?"readonly":""#)></td>
    <td class="gdfCell taskAssigs">(#=obj.getAssigsString()#)</td>
  </tr>
  --></div>

<div class="__template__" type="TASKEMPTYROW"><!--
  <tr class="taskEditRow emptyRow" >
    <th class="gdfCell" align="right"></th>
    <td class="gdfCell noClip" align="center"></td>
    <td class="gdfCell"></td>
    <td class="gdfCell"></td>
    <td class="gdfCell"></td>
    <td class="gdfCell"></td>
    <td class="gdfCell"></td>
    <td class="gdfCell"></td>
    <td class="gdfCell"></td>
    <td class="gdfCell"></td>
    <td class="gdfCell requireCanSeeDep"></td>
    <td class="gdfCell"></td>
  </tr>
  --></div>

<div class="__template__" type="TASKBAR"><!--
  <div class="taskBox taskBoxDiv" taskId="(#=obj.id#)" >
    <div class="layout (#=obj.hasExternalDep?'extDep':''#)">
      <div class="taskStatus" status="(#=obj.status#)"></div>
      <div class="taskProgress" style="width:(#=obj.progress>100?100:obj.progress#)%; background-color:(#=obj.progress>100?'red':'rgb(153,255,51);'#);"></div>
      <div class="milestone (#=obj.startIsMilestone?'active':''#)" ></div>

      <div class="taskLabel"></div>
      <div class="milestone end (#=obj.endIsMilestone?'active':''#)" ></div>
    </div>
  </div>
  --></div>


<div class="__template__" type="CHANGE_STATUS"><!--
    <div class="taskStatusBox">
    <div class="taskStatus cvcColorSquare" status="BACKLOG" title="Backlog"></div>
    <div class="taskStatus cvcColorSquare" status="IN_PROGRESS" title="In Progress"></div>
    <div class="taskStatus cvcColorSquare" status="BLOCKED" title="Blocked"></div>
    <div class="taskStatus cvcColorSquare" status="CANCELLED" title="Cancelled"></div>
    <div class="taskStatus cvcColorSquare" status="RETIRED" title="Retired" style="display: none;"></div>
    <div class="taskStatus cvcColorSquare" status="COMPLETE" title="Complete"></div>
    <div class="taskStatus cvcColorSquare" status="DEFERRED" title="Deferred"></div>
    </div>
  --></div>




<div class="__template__" type="TASK_EDITOR"><!--
  <div class="ganttTaskEditor">
    <h2 class="taskData">Task editor</h2>
    <table  cellspacing="1" cellpadding="5" width="100%" class="taskData table" border="0">
          <tr>
        <td width="200" style="height: 80px"  valign="top">
          <label for="code">code/short name</label><br>
          <input type="text" name="code" id="code" value="" size=15 class="formElements" autocomplete='off' maxlength=255 style='width:100%' oldvalue="1">
        </td>
        <td colspan="3" valign="top"><label for="name" class="required">name</label><br><input type="text" name="name" id="name"class="formElements" autocomplete='off' maxlength=255 style='width:100%' value="" required="true" oldvalue="1"></td>
          </tr>


      <tr class="dateRow">
        <td nowrap="">
          <div style="position:relative">
            <label for="start">start</label>&nbsp;&nbsp;&nbsp;&nbsp;
            <input type="checkbox" id="startIsMilestone" name="startIsMilestone" value="yes"> &nbsp;<label for="startIsMilestone">is milestone</label>&nbsp;
            <br><input type="text" name="start" id="start" size="8" class="formElements dateField validated date" autocomplete="off" maxlength="255" value="" oldvalue="1" entrytype="DATE">
            <span title="calendar" id="starts_inputDate" class="teamworkIcon openCalendar" onclick="$(this).dateField({inputField:$(this).prevAll(':input:first'),isSearchField:false});">m</span>          </div>
        </td>
        <td nowrap="">
          <label for="end">End</label>&nbsp;&nbsp;&nbsp;&nbsp;
          <input type="checkbox" id="endIsMilestone" name="endIsMilestone" value="yes"> &nbsp;<label for="endIsMilestone">is milestone</label>&nbsp;
          <br><input type="text" name="end" id="end" size="8" class="formElements dateField validated date" autocomplete="off" maxlength="255" value="" oldvalue="1" entrytype="DATE">
          <span title="calendar" id="ends_inputDate" class="teamworkIcon openCalendar" onclick="$(this).dateField({inputField:$(this).prevAll(':input:first'),isSearchField:false});">m</span>
        </td>
        <td nowrap="" >
          <label for="duration" class=" ">Days</label><br>
          <input type="text" name="duration" id="duration" size="4" class="formElements validated durationdays" title="Duration is in working days." autocomplete="off" maxlength="255" value="" oldvalue="1" entrytype="DURATIONDAYS">&nbsp;
        </td>
      </tr>

      <tr>
        <td  colspan="2">
          <label for="status" class=" ">status</label><br>
          <select id="status" name="status" class="taskStatus" status="(#=obj.status#)"  onchange="$(this).attr('STATUS',$(this).val());">
            <option value="BACKLOG" class="taskStatus" status="BACKLOG" >Backlog</option>
            <option value="IN_PROGRESS" class="taskStatus" status="IN_PROGRESS" >In Progress</option>
            <option value="BLOCKED" class="taskStatus" status="BLOCKED" >Blocked</option>
            <option value="CANCELLED" class="taskStatus" status="CANCELLED" >Cancelled</option>
            <option value="RETIRED" class="taskStatus" status="RETIRED" >Retired</option>
            <option value="COMPLETE" class="taskStatus" status="COMPLETE" >Complete</option>
            <option value="DEFERRED" class="taskStatus" status="DEFERRED" >Deferred</option>
          </select>
        </td>

        <td valign="top" nowrap>
          <label>progress</label><br>
          <input type="text" name="progress" id="progress" size="7" class="formElements validated percentile" autocomplete="off" maxlength="255" value="" oldvalue="1" entrytype="PERCENTILE">
        </td>
      </tr>

          </tr>
          <tr>
            <td colspan="4">
              <label for="description">Description</label><br>
              <textarea rows="3" cols="30" id="description" name="description" class="formElements" style="width:100%"></textarea>
            </td>
          </tr>
        </table>

    <h2>Assignments</h2>
  <table  cellspacing="1" cellpadding="0" width="100%" id="assigsTable">
    <tr>
      <th style="width:100px;">name</th>
      <th style="width:70px;">Role</th>
      <th style="width:30px;">est.wklg.</th>
      <th style="width:30px;" id="addAssig"><span class="teamworkIcon" style="cursor: pointer">+</span></th>
    </tr>
  </table>

  <div style="text-align: right; padding-top: 20px">
    <span id="saveButton" class="button first" onClick="$(this).trigger('saveFullEditor.gantt');">Save</span>
  </div>

  </div>
  --></div>



<div class="__template__" type="ASSIGNMENT_ROW"><!--
  <tr taskId="(#=obj.task.id#)" assId="(#=obj.assig.id#)" class="assigEditRow" >
    <td ><select name="resourceId"  class="formElements" (#=obj.assig.id.indexOf("tmp_")==0?"":"disabled"#) ></select></td>
    <td ><select type="select" name="roleId"  class="formElements"></select></td>
    <td ><input type="text" name="effort" value="(#=getMillisInHoursMinutes(obj.assig.effort)#)" size="5" class="formElements"></td>
    <td align="center"><span class="teamworkIcon delAssig del" style="cursor: pointer">d</span></td>
  </tr>
  --></div>



<div class="__template__" type="RESOURCE_EDITOR"><!--
  <div class="resourceEditor" style="padding: 5px;">

    <h2>Project team</h2>
    <table  cellspacing="1" cellpadding="0" width="100%" id="resourcesTable">
      <tr>
        <th style="width:100px;">name</th>
        <th style="width:30px;" id="addResource"><span class="teamworkIcon" style="cursor: pointer">+</span></th>
      </tr>
    </table>

    <div style="text-align: right; padding-top: 20px"><button id="resSaveButton" class="button big">Save</button></div>
  </div>
  --></div>



<div class="__template__" type="RESOURCE_ROW"><!--
  <tr resId="(#=obj.id#)" class="resRow" >
    <td ><input type="text" name="name" value="(#=obj.name#)" style="width:100%;" class="formElements"></td>
    <td align="center"><span class="teamworkIcon delRes del" style="cursor: pointer">d</span></td>
  </tr>
  --></div>


</div>
<script type="text/javascript">
  $.JST.loadDecorator("RESOURCE_ROW", function(resTr, res){
    resTr.find(".delRes").click(function(){$(this).closest("tr").remove()});
  });

  $.JST.loadDecorator("ASSIGNMENT_ROW", function(assigTr, taskAssig){
    var resEl = assigTr.find("[name=resourceId]");
    var opt = $("<option>");
    resEl.append(opt);
    for(var i=0; i< taskAssig.task.master.resources.length;i++){
      var res = taskAssig.task.master.resources[i];
      opt = $("<option>");
      opt.val(res.id).html(res.name);
      if(taskAssig.assig.resourceId == res.id)
        opt.attr("selected", "true");
      resEl.append(opt);
    }
    var roleEl = assigTr.find("[name=roleId]");
    for(var i=0; i< taskAssig.task.master.roles.length;i++){
      var role = taskAssig.task.master.roles[i];
      var optr = $("<option>");
      optr.val(role.id).html(role.name);
      if(taskAssig.assig.roleId == role.id)
        optr.attr("selected", "true");
      roleEl.append(optr);
    }

    if(taskAssig.task.master.permissions.canWrite && taskAssig.task.canWrite){
      assigTr.find(".delAssig").click(function(){
        var tr = $(this).closest("[assId]").fadeOut(200, function(){$(this).remove()});
      });
    }

  });


  /**
   * Loads internationalization (i18n) messages into the GanttMaster object.
   * These messages are used for UI display, errors, and task-related notifications.
   *
   * @return {void} No return value. The function initializes and assigns messages to the GanttMaster object.
   */
  function loadI18n(){
    GanttMaster.messages = {
      "CANNOT_WRITE":"No permission to change the following task:",
      "CHANGE_OUT_OF_SCOPE":"Project update not possible as you lack rights for updating a parent project.",
      "START_IS_MILESTONE":"Start date is a milestone.",
      "END_IS_MILESTONE":"End date is a milestone.",
      "TASK_HAS_CONSTRAINTS":"Task has constraints.",
      "GANTT_ERROR_DEPENDS_ON_OPEN_TASK":"Error: there is a dependency on an open task.",
      "GANTT_ERROR_DESCENDANT_OF_CLOSED_TASK":"Error: due to a descendant of a closed task.",
      "TASK_HAS_EXTERNAL_DEPS":"This task has external dependencies.",
      "GANNT_ERROR_LOADING_DATA_TASK_REMOVED":"GANNT_ERROR_LOADING_DATA_TASK_REMOVED",
      "CIRCULAR_REFERENCE":"Circular reference.",
      "CANNOT_DEPENDS_ON_ANCESTORS":"Cannot depend on ancestors.",
      "INVALID_DATE_FORMAT":"The data inserted are invalid for the field format.",
      "GANTT_ERROR_LOADING_DATA_TASK_REMOVED":"An error has occurred while loading the data. A task has been trashed.",
      "CANNOT_CLOSE_TASK_IF_OPEN_ISSUE":"Cannot close a task with open issues",
      "TASK_MOVE_INCONSISTENT_LEVEL":"You cannot exchange tasks of different depth.",
      "CANNOT_MOVE_TASK":"CANNOT_MOVE_TASK",
      "PLEASE_SAVE_PROJECT":"PLEASE_SAVE_PROJECT",
      "GANTT_SEMESTER":"Semester",
      "GANTT_SEMESTER_SHORT":"s.",
      "GANTT_QUARTER":"Quarter",
      "GANTT_QUARTER_SHORT":"q.",
      "GANTT_WEEK":"Week",
      "GANTT_WEEK_SHORT":"w."
    };
  }



  /**
   * Creates a new resource by opening a popup dialog and setting the selected resource details on the UI.
   *
   * @param {HTMLElement} el The element that triggered the creation of a new resource. Used to find the corresponding row and update its data.
   * @return {void} This function does not return any value but updates the input fields in the corresponding row with the new resource details.
   */
  function createNewResource(el)
  {
    var row = el.closest("tr[taskid]");
    var name = row.find("[name=resourceId_txt]").val();
    var url = contextPath + "/applications/teamwork/resource/resourceNew.jsp?CM=ADD&name=" + encodeURI(name);

    openBlackPopup(url, 700, 320, function (response) {
      //fillare lo smart combo
      if (response && response.resId && response.resName) {
        //fillare lo smart combo e chiudere l'editor
        row.find("[name=resourceId]").val(response.resId);
        row.find("[name=resourceId_txt]").val(response.resName).focus().blur();
      }

    });
  }

$(document).on("change", "#load-file", function() {
  var uploadedFile = $("#load-file").prop("files")[0];
  upload(uploadedFile);
});
let cMenu = null;
let cMenuVisible = false;
function showContextMenu(event, target)
{
    if(event.target.classList.contains('ganttButtonBar')||event.target.classList.contains('buttons'))
    {
        cMenu.style.display = 'none';
        cMenuVisible = false;
        event.preventDefault();
        return 0;
    }

    if(cMenuVisible)
    {
        cMenu.style.display = 'none';
        cMenuVisible = false;
    }
    event.preventDefault();



    console.log(event.target);
    console.log(event.target.classList);

    if(document.querySelector('.gdfWrapper').contains(event.target))
    {
        cMenu = tableContextMenu;
        console.log('GDF WRAPPER');
    }
    else if(document.querySelector('.splitBox2').contains(event.target))
    {
        if(event.target.classList.contains("taskLayout"))
        {
            cMenu = taskbarContextMenu;
            console.log('TASK BAR');
        }
        else
        {
            cMenu = nonTaskGanttContextMenu;
            console.log('SPLIT BOX 2');
        }
    }
    console.log(cMenu);
    cMenu.style.top = `${event.clientY}px`;
    cMenu.style.left = `${event.clientX}px`;
    cMenu.style.display = 'block';
    cMenuVisible = true;

    // Optionally store information about the clicked target
    cMenu.dataset.target = target.getAttribute('taskid');
}
	
	/**
     * Hides the context menu if the clicked target is outside of the specified menu element.
     *
     * @param {Event} event The event object representing the user interaction.
     * @param {HTMLElement} target The target HTML element associated with the context menu.
     * @return {void}
     */
    function hideContextMenu(event, target)
	{
		if(!cMenu.contains(event.target))
		{
			cMenu.style.display = 'none';
			cMenuVisible = false;
		}
	}
	
	/**
     * Handles the triggering of a context menu when a specific event occurs.
     * This function displays the context menu at the position of the event
     * and sets up the behavior for closing the menu upon a click elsewhere.
     *
     * @param {Event} event - The event object representing the triggering action,
     * typically a right-click or context menu event.
     * @return {void} This function does not return a value.
     */
    function fireUpContextMenu(event)
	{
		console.log('Caught the context menu event');
		
		// Set up the close behaviour of the menu
		document.addEventListener('click', hideContextMenu);
		
		showContextMenu(event, this);
	}

	document.addEventListener("contextmenu", fireUpContextMenu);

</script>

<div id="nonTaskGanttContextMenu" style="display:none; position:absolute; background:#fff; border:1px solid #ccc; box-shadow:2px 2px 6px rgba(0,0,0,0.2); z-index:1000;">
    <ul style="list-style:none; margin:0; padding:0;">
        <li style="padding:8px; cursor:pointer;" onclick="onMenuAction('edit')">nonTaskGantt`</li>
        <li style="padding:8px; cursor:pointer;" onclick="onMenuAction('delete')">Delete Task</li>
        <li style="padding:8px; cursor:pointer;" onclick="onMenuAction('details')">View Details</li>
    </ul>
</div>

<div id="tableContextMenu" style="display:none; position:absolute; background:#fff; border:1px solid #ccc; box-shadow:2px 2px 6px rgba(0,0,0,0.2); z-index:1000;">
    <ul style="list-style:none; margin:0; padding:0;">
        <li style="padding:8px; cursor:pointer;" onclick="onMenuAction('edit')">table</li>
        <li style="padding:8px; cursor:pointer;" onclick="onMenuAction('delete')">Delete Task</li>
        <li style="padding:8px; cursor:pointer;" onclick="onMenuAction('details')">View Details</li>
    </ul>
</div>

<div id="taskbarContextMenu" style="display:none; position:absolute; background:#fff; border:1px solid #ccc; box-shadow:2px 2px 6px rgba(0,0,0,0.2); z-index:1000;">
    <ul style="list-style:none; margin:0; padding:0;">
        <li style="padding:8px; cursor:pointer;" onclick="onMenuAction('edit')">taskGantt</li>
        <li style="padding:8px; cursor:pointer;" onclick="onMenuAction('delete')">Delete Task</li>
        <li style="padding:8px; cursor:pointer;" onclick="onMenuAction('details')">View Details</li>
    </ul>
</div>

</body>
</html>